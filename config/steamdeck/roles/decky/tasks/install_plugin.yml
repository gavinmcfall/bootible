# Install a single Decky plugin from the official Decky Plugin Store
# This file is included by main.yml for each enabled plugin

---
# Reset variables for each plugin
- name: Reset plugin variables for {{ plugin.key }}
  ansible.builtin.set_fact:
    plugin_zip_url: ""
    plugin_version: ""
    plugin_store_name: ""

# Fetch the Decky Plugin Store catalog
- name: Fetch Decky store plugin list for {{ plugin.key }}
  ansible.builtin.uri:
    url: "https://plugins.deckbrew.xyz/plugins"
    return_content: true
  register: decky_store
  failed_when: false

- name: Warn on Decky store fetch failure for {{ plugin.key }}
  ansible.builtin.debug:
    msg: "Could not fetch Decky store: {{ decky_store.msg | default('Unknown error') }}"
  when: decky_store.status | default(0) != 200

# Find plugin in the store by store_name
- name: Find plugin in Decky store for {{ plugin.key }}
  vars:
    search_name: "{{ plugin.value.store_name | default(plugin.key) }}"
    store_plugin: "{{ decky_store.json | default([]) | selectattr('name', 'equalto', search_name) | first | default({}) }}"
    latest_version: "{{ store_plugin.versions[0] | default({}) }}"
  ansible.builtin.set_fact:
    plugin_zip_url: "https://cdn.tzatzikiweeb.moe/file/steam-deck-homebrew/versions/{{ latest_version.hash }}.zip"
    plugin_version: "{{ latest_version.name }}"
    plugin_store_name: "{{ store_plugin.name | default('') }}"
  when:
    - decky_store.status | default(0) == 200
    - store_plugin.name is defined
    - latest_version.hash is defined
  failed_when: false

- name: Warn if plugin not found in store for {{ plugin.key }}
  ansible.builtin.debug:
    msg: "Plugin '{{ plugin.value.store_name | default(plugin.key) }}' not found in Decky store - check store_name in config"
  when: plugin_store_name | default('') | length == 0

# Check if plugin is already installed
- name: Check if plugin directory exists for {{ plugin.key }}
  ansible.builtin.find:
    paths: "{{ deck_home }}/homebrew/plugins"
    file_type: directory
    recurse: false
  register: installed_plugins

- name: Check if this plugin is installed for {{ plugin.key }}
  ansible.builtin.set_fact:
    plugin_installed: "{{ installed_plugins.files | map(attribute='path') | map('basename') | select('search', plugin.key) | list | length > 0 }}"

# Download plugin zip
- name: Download plugin for {{ plugin.key }}
  ansible.builtin.get_url:
    url: "{{ plugin_zip_url }}"
    dest: "{{ plugin_temp.path }}/{{ plugin.key }}.zip"
    mode: '0644'
  when:
    - plugin_zip_url | default('') | length > 0
    - not plugin_installed
  register: plugin_download
  failed_when: false

- name: Warn on download failure for {{ plugin.key }}
  ansible.builtin.debug:
    msg: "Download failed for {{ plugin.key }}: {{ plugin_download.msg | default('Unknown error') }}"
  when:
    - plugin_download is defined
    - plugin_download is failed

# Extract plugin
- name: Extract plugin for {{ plugin.key }}
  ansible.builtin.unarchive:
    src: "{{ plugin_temp.path }}/{{ plugin.key }}.zip"
    dest: "{{ deck_home }}/homebrew/plugins/"
    remote_src: true
  when:
    - plugin_download is defined
    - plugin_download is changed
  failed_when: false

# Log result
- name: Log installation result for {{ plugin.key }}
  ansible.builtin.debug:
    msg: >-
      {% if plugin_download is defined and plugin_download is changed %}
      ✓ Installed {{ plugin_store_name }} v{{ plugin_version }}
      {% elif plugin_installed %}
      ✓ {{ plugin.key }} already installed
      {% elif plugin_zip_url | default('') | length == 0 %}
      ✗ {{ plugin.key }} not found in Decky store (check store_name)
      {% else %}
      ✗ Could not install {{ plugin.key }}
      {% endif %}
    verbosity: 0
